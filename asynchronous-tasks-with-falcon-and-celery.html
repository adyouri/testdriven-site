<!DOCTYPE html>
<html>

  <head>
  <!-- meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" type="image/png" href="/favicon.png">
  <!-- og -->
  
    <meta property="og:image" content="https://testdriven.io/assets/img/blog/falcon-celery/async_falcon_celery.png" />
  
  <!-- description -->
  
    <meta name="description" property="og:description" content="This post shows how to integrate Celery into the Python-based Falcon web framework.">
  
  <!-- keywords -->
  
    <meta name="keywords" content="python, web development, falcon web framework, falcon, celery, redis, asynchronous tasks, task queue, docker, falcon python">
  
  <!-- title -->
  
    <title>Asynchronous Tasks with Falcon and Celery - TestDriven.io</title>
    <meta property="og:title" content="Asynchronous Tasks with Falcon and Celery" />
  
  <!-- styles -->
  <link rel="stylesheet" href="/assets/vendor/bootstrap.min.css">
  <link href="//use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
  <link href="/assets/css/styles.css?1525303040746579000" rel="stylesheet">
</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/">Course</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/course-contents">Contents</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/testimonials">Testimonials</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">Blog</a>
        </li>
      </ul>
    </div>
    <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
      <li class="nav-item">
        <a class="nav-link" href="https://twitter.com/testdrivenio"><i class="fab fa-twitter"></i></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/testdrivenio"><i class="fab fa-github"></i></a>
      </li>
      <li class="nav-item nav-purcahse-btn">
        <a class="btn btn-outline-warning" href="https://gum.co/flask">Purchase the Course</a>
      </li>
  </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col-lg-9">

          
            <div class="text-center" style="padding-bottom:20px;">
              <img src="/assets/img/blog/falcon-celery/async_falcon_celery.png" style="max-width:100%" alt="falcon and celery">
            </div>
          

          <h1>Asynchronous Tasks with Falcon and Celery</h1>

          
            <p>Posted by <a href="https://testdriven.io/authors/herman">Michael Herman</a></span> on <span class="badge badge-secondary">Mar 12, 2018</span><br>
  
    <br>
    <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Asynchronous Tasks with Falcon and Celery&amp;url=https%3A%2F%2Ftestdriven.io/asynchronous-tasks-with-falcon-and-celery&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  

</p>
          

          <p>Asynchronous tasks are used to move intensive, time-consuming processes, which are prone to failure, to the background so a response can be returned immediately to the client.</p>

<p>This post looks at how to integrate <a href="http://www.celeryproject.org/">Celery</a>, an asynchronous task queue, into the Python-based <a href="https://falconframework.org/">Falcon</a> web framework. We’ll also use Docker and Docker Compose to tie everything together. Finally, we’ll look at how to test the Celery tasks with unit and integration tests.</p>

<h2 class="no_toc">Contents</h2>

<ul class="no_toc" id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#background-tasks" id="markdown-toc-background-tasks">Background Tasks</a></li>
  <li><a href="#falcon-framework" id="markdown-toc-falcon-framework">Falcon Framework</a></li>
  <li><a href="#project-setup" id="markdown-toc-project-setup">Project Setup</a></li>
  <li><a href="#celery" id="markdown-toc-celery">Celery</a></li>
  <li><a href="#flower" id="markdown-toc-flower">Flower</a></li>
  <li><a href="#flow" id="markdown-toc-flow">Flow</a></li>
  <li><a href="#tests" id="markdown-toc-tests">Tests</a></li>
  <li><a href="#next-steps" id="markdown-toc-next-steps">Next Steps</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<p>By the end of this post, you should be able to:</p>

<ol>
  <li>Integrate Celery into a Falcon web app.</li>
  <li>Containerize Falcon, Celery, and Redis with Docker.</li>
  <li>Execute tasks in the background with a separate worker process.</li>
  <li>Save Celery logs to a file.</li>
  <li>Set up <a href="http://flower.readthedocs.io/">Flower</a> to monitor and administer Celery jobs and workers.</li>
  <li>Test a Celery task with both unit and integration tests.</li>
</ol>

<h2 id="background-tasks">Background Tasks</h2>

<p>Again, to improve user experience, long-running processes should be ran outside the normal HTTP request/response flow, in a background process.</p>

<p>Examples:</p>

<ol>
  <li>Sending confirmation emails</li>
  <li>Scraping and crawling</li>
  <li>Analyzing data</li>
  <li>Image processing</li>
</ol>

<p>As you’re building out an app, try to distinguish tasks that should run during the request/response lifecycle, like CRUD operations, from those should run in the background.</p>

<h2 id="falcon-framework">Falcon Framework</h2>

<p><a href="https://falconframework.org/">Falcon</a> is a micro Python web framework that’s great for creating back-end, RESTful APIs. Falcon feels much like Flask, but it’s a lot faster in terms of both development and <a href="https://falconframework.org/#sectionBenchmarks">performance</a>.</p>

<blockquote>
  <p>Falcon is a minimalist WSGI library for building speedy web APIs and app backends. We like to think of Falcon as the Dieter Rams of web frameworks.</p>

  <p>When it comes to building HTTP APIs, other frameworks weigh you down with tons of dependencies and unnecessary abstractions. Falcon cuts to the chase with a clean design that embraces HTTP and the REST architectural style.</p>
</blockquote>

<p>Be sure to review the official <a href="https://falcon.readthedocs.io/en/stable/">docs</a> for more information.</p>

<h2 id="project-setup">Project Setup</h2>

<p>Clone down the base project:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/testdrivenio/falcon-celery <span class="nt">--branch</span> base <span class="nt">--single-branch</span>
<span class="nv">$ </span><span class="nb">cd </span>falcon-celery
</code></pre></div></div>

<p>Take a quick glance at the code as well as the project structure, and then spin up the app using Docker:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>This should only take a moment to build and run the images. Once done, the app should be live on <a href="http://localhost:8000/ping">http://localhost:8000/ping</a>.</p>

<p>Ensure the tests pass:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python test.py
<span class="nb">.</span>
<span class="nt">----------------------------------------------------------------------</span>
Ran 1 <span class="nb">test </span><span class="k">in </span>0.001s

OK
</code></pre></div></div>

<h2 id="celery">Celery</h2>

<p>Now comes the fun part - adding <a href="http://www.celeryproject.org/">Celery</a>! Start by adding both Celery and Redis to the <em>requirements.txt</em> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>celery==4.1.0
falcon==1.4.1
gunicorn==19.7.1
redis==2.10.6
</code></pre></div></div>

<h3 id="create-a-task">Create a Task</h3>

<p>Add a new file to the “project/app” directory called <em>tasks.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># project/app/tasks.py</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span> <span class="nn">celery</span>


<span class="n">CELERY_BROKER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'CELERY_BROKER'</span><span class="p">)</span>
<span class="n">CELERY_BACKEND</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'CELERY_BACKEND'</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">Celery</span><span class="p">(</span><span class="s">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">CELERY_BROKER</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">CELERY_BACKEND</span><span class="p">)</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c"># simulate slow computation</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></div>

<p>Here, we created a new instance of Celery and defined a new Celery <a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html">task</a> called <code class="highlighter-rouge">fib</code> that calculates the fibonacci sequence from a given number.</p>

<p>Celery uses a message <a href="http://docs.celeryproject.org/en/latest/getting-started/brokers/">broker</a> to facilitate communication between the Celery worker and the web application. Messages are added to the broker, which are then processed by the worker(s). Once done, the results are added to the backend.</p>

<p>Redis will be used as both the broker and backend. Add both Redis and a Celery <a href="http://docs.celeryproject.org/en/latest/userguide/workers.html">worker</a> to the <em>docker-compose.yml</em> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.5'</span>

<span class="na">services</span><span class="pi">:</span>

  <span class="na">web</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">./project</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">8000:8000'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">./project:/usr/src/app'</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">gunicorn -b 0.0.0.0:8000 app:app</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">CELERY_BROKER=redis://redis:6379/0</span>
      <span class="pi">-</span> <span class="s">CELERY_BACKEND=redis://redis:6379/0</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">redis</span>

  <span class="na">celery</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">web</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">./project:/usr/src/app'</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">celery -A app.tasks worker --loglevel=info</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">CELERY_BROKER=redis://redis:6379/0</span>
      <span class="pi">-</span> <span class="s">CELERY_BACKEND=redis://redis:6379/0</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">web</span>
      <span class="pi">-</span> <span class="s">redis</span>

  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">redis:3.2.11</span>
</code></pre></div></div>

<p>Add a new route handler to kick off the <code class="highlighter-rouge">fib</code> task to <em>__init__.py</em>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">raw_json</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_json</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">fib</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s">'number'</span><span class="p">]))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'status'</span><span class="p">:</span> <span class="s">'success'</span><span class="p">,</span>
            <span class="s">'data'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">'task_id'</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="nb">id</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>Register the route:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'/create'</span><span class="p">,</span> <span class="n">CreateTask</span><span class="p">())</span>
</code></pre></div></div>

<p>Import the task:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">app.tasks</span> <span class="kn">import</span> <span class="n">fib</span>
</code></pre></div></div>

<p>Build the image and spin up the containers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>Test:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> POST http://localhost:8000/create <span class="se">\</span>
    <span class="nt">-d</span> <span class="s1">'{"number":"4"}'</span> <span class="se">\</span>
    <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div></div>

<p>You should see something like:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"success"</span>,
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"task_id"</span>: <span class="s2">"d935fa51-44ad-488f-b63d-6b0e178700a8"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="check-task-status">Check Task Status</h3>

<p>Next, add a new route handler to check the status of the task:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CheckStatus</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">on_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">task_result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">'status'</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s">'result'</span><span class="p">:</span> <span class="n">task_result</span><span class="o">.</span><span class="n">result</span><span class="p">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">falcon</span><span class="o">.</span><span class="n">HTTP_200</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>Register the route:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'/status/{task_id}'</span><span class="p">,</span> <span class="n">CheckStatus</span><span class="p">())</span>
</code></pre></div></div>

<p>Import <a href="http://docs.celeryproject.org/en/latest/reference/celery.result.html">AsyncResult</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">AsyncResult</span>
</code></pre></div></div>

<p>Update the containers:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>Trigger a new task:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-X</span> POST http://localhost:8000/create <span class="se">\</span>
    <span class="nt">-d</span> <span class="s1">'{"number":"3"}'</span> <span class="se">\</span>
    <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>

<span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"success"</span>,
  <span class="s2">"data"</span>: <span class="o">{</span>
    <span class="s2">"task_id"</span>: <span class="s2">"65a1c427-ee08-4fb1-9842-d0f90d081c54"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Then, use the returned <code class="highlighter-rouge">task_id</code> to check the status:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8000/status/65a1c427-ee08-4fb1-9842-d0f90d081c54

<span class="o">{</span>
  <span class="s2">"status"</span>: <span class="s2">"SUCCESS"</span>, <span class="s2">"result"</span>: <span class="o">[</span>0, 1, 1, 2]
<span class="o">}</span>
</code></pre></div></div>

<h3 id="logs">Logs</h3>

<p>Update the <code class="highlighter-rouge">celery</code> service so that Celery logs are dumped to a log file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">celery</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">./project:/usr/src/app'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">./project/logs:/usr/src/app/logs'</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">celery -A app.tasks worker --loglevel=info  --logfile=logs/celery.log</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">CELERY_BROKER=redis://redis:6379/0</span>
    <span class="pi">-</span> <span class="s">CELERY_BACKEND=redis://redis:6379/0</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">web</span>
    <span class="pi">-</span> <span class="s">redis</span>
</code></pre></div></div>

<p>Update:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>You should see the log file in <em>logs/celery.log</em> locally since we set up a volume:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[2018-03-08 21:52:32,500: INFO/MainProcess] Connected to redis://redis:6379/0
[2018-03-08 21:52:32,512: INFO/MainProcess] mingle: searching for neighbors
[2018-03-08 21:52:33,539: INFO/MainProcess] mingle: all alone
[2018-03-08 21:52:33,554: INFO/MainProcess] celery@0a21f3f54410 ready.
[2018-03-08 21:52:34,415: INFO/MainProcess] Events of group {task} enabled by remote.
[2018-03-08 21:52:46,631: INFO/MainProcess] Received task: app.tasks.fib[20704c3f-3964-47cb-8bd2-b20b788fc372]  
[2018-03-08 21:52:52,652: INFO/ForkPoolWorker-1] Task app.tasks.fib[20704c3f-3964-47cb-8bd2-b20b788fc372] succeeded in 6.015212989994325s: [0, 1, 1, 2]
</code></pre></div></div>

<h2 id="flower">Flower</h2>

<p><a href="http://flower.readthedocs.io/">Flower</a> is a real-time, web-based monitoring tool for Celery. You can monitor currently running tasks, increase or decrease the worker pool, view graphs and a number of statistics, to name a few.</p>

<p>Add it to <em>requirements.txt:</em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>celery==4.1.0
falcon==1.4.1
flower==0.9.2
gunicorn==19.7.1
redis==2.10.6
</code></pre></div></div>

<p>And then add the service to <em>docker-compose.yml</em>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">monitor</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">5555:5555'</span>
  <span class="na">command</span><span class="pi">:</span>  <span class="s">flower -A app.tasks --port=5555 --broker=redis://redis:6379/0</span>
  <span class="na">depends_on</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">web</span>
    <span class="pi">-</span> <span class="s">redis</span>
</code></pre></div></div>

<p>Test it out:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up <span class="nt">-d</span> <span class="nt">--build</span>
</code></pre></div></div>

<p>Navigate to <a href="http://localhost:5555">http://localhost:5555</a> to view the dashboard. You should see one worker ready to go:</p>

<p><img src="/assets/img/blog/falcon-celery/flower1.png" style="max-width:90%;padding-top:20px;" alt="flower" /></p>

<p>Trigger a few more tasks:</p>

<p><img src="/assets/img/blog/falcon-celery/flower2.png" style="max-width:90%;padding-top:20px;padding-bottom:20px;" alt="flower" /></p>

<h2 id="flow">Flow</h2>

<p>Before writing any tests, let’s take a step back and look at the overall workflow.</p>

<p>In essence, an HTTP POST request hits <code class="highlighter-rouge">/create</code>. Within the route handler, a message is added to the broker, and the Celery worker process grabs it from the queue and processes the task. Meanwhile, the web application continues to execute and function properly, sending a response back to the client with a task ID. The client can then hit the <code class="highlighter-rouge">/status/&lt;TASK_ID&gt;</code> endpoint with an HTTP GET request to check the status of the task.</p>

<p><img src="/assets/img/blog/falcon-celery/falcon-celery-flow.png" style="max-width:90%;padding-top:20px;padding-bottom:20px;" alt="falcon celery flow" /></p>

<h2 id="tests">Tests</h2>

<p>Let’s start with a unit test:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestCeleryTasks</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_fib_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</code></pre></div></div>

<p>Add the above test case to <em>project/test.py</em>, and then update the imports:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">falcon</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">tasks</span>
</code></pre></div></div>

<p>Run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python test.py
</code></pre></div></div>

<p>It should take about 20 seconds to run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>..
<span class="nt">----------------------------------------------------------------------</span>
Ran 2 tests <span class="k">in </span>20.038s

OK
</code></pre></div></div>

<p>It’s worth noting that in the above asserts, we used the <code class="highlighter-rouge">.run</code> method (rather than <code class="highlighter-rouge">.delay</code>) to run the task directly without a Celery worker.</p>

<p>Want to mock out the Celery task?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestCeleryTasks</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="c"># def test_fib_task(self):</span>
    <span class="c">#     self.assertEqual(tasks.fib.run(-1), [])</span>
    <span class="c">#     self.assertEqual(tasks.fib.run(1), [0, 1])</span>
    <span class="c">#     self.assertEqual(tasks.fib.run(3), [0, 1, 1, 2])</span>
    <span class="c">#     self.assertEqual(tasks.fib.run(5), [0, 1, 1, 2, 3, 5])</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s">'app.tasks.fib'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_mock_fib_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_fib</span><span class="p">):</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">mock_fib</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">fib</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
</code></pre></div></div>

<p>Add the import:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose run web python test.py


..
<span class="nt">----------------------------------------------------------------------</span>
Ran 2 tests <span class="k">in </span>0.002s

OK
</code></pre></div></div>

<p>Much better!</p>

<p>You can also run a full integration test from outside the container by running the following script:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># trigger jobs</span>
<span class="nb">test</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-X</span> POST http://localhost:8000/create <span class="se">\</span>
    <span class="nt">-d</span> <span class="s1">'{"number":"2"}'</span> <span class="se">\</span>
    <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
    <span class="nt">-s</span> <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.data.task_id'</span><span class="sb">`</span>

<span class="c"># get status</span>
<span class="nv">check</span><span class="o">=</span><span class="sb">`</span>curl http://localhost:8000/status/<span class="k">${</span><span class="nv">test</span><span class="k">}</span> <span class="nt">-s</span> | jq <span class="nt">-r</span> <span class="s1">'.status'</span><span class="sb">`</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"SUCCESS"</span> <span class="o">]</span>
<span class="k">do
  </span><span class="nv">check</span><span class="o">=</span><span class="sb">`</span>curl http://localhost:8000/status/<span class="k">${</span><span class="nv">test</span><span class="k">}</span> <span class="nt">-s</span> | jq <span class="nt">-r</span> <span class="s1">'.status'</span><span class="sb">`</span>
  <span class="nb">echo</span> <span class="k">$(</span>curl http://localhost:8000/status/<span class="k">${</span><span class="nv">test</span><span class="k">}</span> <span class="nt">-s</span><span class="k">)</span>
<span class="k">done</span>
</code></pre></div></div>

<p><img src="/assets/img/blog/falcon-celery/test.gif" style="max-width:90%;padding-top:20px;" alt="test" /></p>

<p>Keep in mind that this is hitting the same broker and backend used in development. You may want to instantiate a new Celery app for testing:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">Celery</span><span class="p">(</span><span class="s">'tests'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="n">CELERY_BROKER</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">CELERY_BACKEND</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="next-steps">Next Steps</h2>

<p>Looking for some challenges?</p>

<ol>
  <li>Spin up <a href="https://m.do.co/c/d8f211a4b4c2">Digital Ocean</a> and deploy this application across a number of droplets using Docker Swarm or Kubernetes.</li>
  <li>Add a basic client side with React, Angular, Vue, or just vanilla JavaScript. Allow an end user to kick off a new task. Set up a polling mechanism to check the status of a task as well.</li>
</ol>

<p>Grab the code from the <a href="https://github.com/testdrivenio/falcon-celery">repo</a>.</p>


          
  
    <br>
    <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Asynchronous Tasks with Falcon and Celery&amp;url=https%3A%2F%2Ftestdriven.io/asynchronous-tasks-with-falcon-and-celery&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  



        </div>

        <div class="col-md-3 d-none d-lg-block">
  <div class="card box-shadow">
    <h4 class="card-header text-center">Microservices with Docker, Flask, and React</h4>
    <div class="card-body text-dark">
      <p class="card-text">Get the full course. Learn how to build, test, and deploy microservices powered by Docker, Flask, and React!</p>
      <div class="text-center">
        <hr>
        <p><a class="btn btn-success btn-lg" href="https://gum.co/flask">Purchase Now!</a></p>
        <p><a href="https://testdriven.io/part-one-intro">Or, preview parts 1 - 3</a></p>
      </div>
    </div>
  </div>
  
  
    <br>
<div class="blog-toc-container card box-shadow">
  <h4 class="card-header text-center">Table of Contents</h4>
  <div class="blog-toc-subcontainer">
    <ul class="blog-toc card-body" id="blog-toc" />
  </div>
</div>
<script>
  const headerList = document.getElementsByTagName('h2');
  let tocContainer = document.getElementById('blog-toc');
  for (el in headerList) {
    if (headerList[el].innerHTML && headerList[el].innerHTML !== 'Contents') {
      // added to anchor target to push target below navbar
      headerList[el].setAttribute('style', 'padding-top: 60px; margin-top: -60px;');
      // create li
      let listElement = document.createElement('li');
      // create anchor
      let anchorElement = document.createElement('a');
      // set text and href values
      anchorElement.innerText = headerList[el].innerHTML;
      anchorElement.href = "#" + headerList[el].id;
      // append anchor to li, append li to ul
      listElement.appendChild(anchorElement);
      tocContainer.appendChild(listElement);
    }
  }
</script>

  
</div>


      </div>

      <hr>

<div class="row">

  <div class="col-sm-12">

    <p><strong>Join our mailing list to be notified about course updates and new tutorials.</strong></p>

    <form class="validate" action="//testdriven.us17.list-manage.com/subscribe/post?u=bea5ac664532063fe8aa8d6a2&amp;id=eddaf58c2a" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank" novalidate>
      <div class="form-group">
        <input placeholder="Enter your email..." type="email" name="EMAIL" class="form-control col-sm-4">
      </div>
      <div>
        &nbsp;<button class="btn btn-success" type="submit" name="action">Submit</button>
      </div>
    </form>

  </div>

</div>


    </div>

     <footer class="footer text-center">
  <div class="container">
    <hr>
    <small>
      <p>
      <span>&copy; Copyright 2018</span>
      <a href="http://testdriven.io">TestDriven.io</a>.
      <br>
      <span>Developed by </span>
      <a href="http://mherman.org/">Michael Herman</a>.
      <br>
      <span>Questions? </span>
      <a href="mailto:michael@mherman.org">michael@mherman.org</a>
      <p>
    </small>
  </div>
</footer>


    <script
  src="//code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"
></script>
<script
  src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  src="/assets/js/main.js"
></script>
<script
  type="text/javascript"
  src="https://gumroad.com/js/gumroad.js"
></script>
<!-- addthis -->

  <script
    type="text/javascript"
    src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50e5f1cc35ad077d"
  ></script>



    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
